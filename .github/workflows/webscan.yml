name: WordPress DAST Security Scan

on:
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰
  schedule:
    - cron: "0 15 * * *"  # ë§¤ì¼ 00:00 KST (UTC 15:00)

permissions:
  contents: read

jobs:
  dast-scan:
    runs-on: ubuntu-latest
    
    env:
      # GitHub Secretsì—ì„œ ê°€ì ¸ì˜¤ê¸°
      TARGET_BASE: ${{ secrets.TARGET_URL }}
      WP_USERNAME: ${{ secrets.WP_USERNAME }}
      WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
      WPSCAN_API_TOKEN: ${{ secrets.WPSCAN_API_TOKEN }}
      DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout
      uses: actions/checkout@v4
    
    # 2. ë„êµ¬ ì„¤ì¹˜
    - name: Install dependencies
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ ë„êµ¬ ì„¤ì¹˜ ì¤‘..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        sudo apt-get update -qq
        
        # WPScan
        echo "â–¶ WPScan..."
        sudo gem install wpscan
        
        # Nuclei
        echo "â–¶ Nuclei..."
        go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
        sudo ln -s ~/go/bin/nuclei /usr/local/bin/nuclei || true
        
        # wfuzz
        echo "â–¶ wfuzz..."
        sudo apt-get install -y wfuzz
        
        # Dalfox
        echo "â–¶ Dalfox..."
        go install github.com/hahwul/dalfox/v2@latest
        sudo ln -s ~/go/bin/dalfox /usr/local/bin/dalfox || true
        
        # SQLMap
        echo "â–¶ SQLMap..."
        sudo apt-get install -y sqlmap
        
        # ê¸°íƒ€ ìœ í‹¸ë¦¬í‹°
        echo "â–¶ Utilities..."
        sudo apt-get install -y jq bc python3-requests
        
        echo ""
        echo "âœ… ë„êµ¬ ì„¤ì¹˜ ì™„ë£Œ!"
        
        # ë²„ì „ í™•ì¸
        echo ""
        echo "ë„êµ¬ ë²„ì „:"
        wpscan --version || true
        nuclei -version || true
        dalfox version || true
        sqlmap --version | head -1 || true
    
    # 3. ì¤€ë¹„
    - name: Prepare directories & permissions
      run: |
        mkdir -p results
        chmod +x scripts/*.sh
        chmod +x scripts/*.py
    
    # 4. WPScan (ê¸°ì¡´ CVE)
    - name: "Scan 1/5: WPScan (Known CVE)"
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "1ï¸âƒ£ WPScan - ê¸°ì¡´ CVE íƒì§€"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/1_wpscan.sh || true
      
    
    # 5. Nuclei (WordPress í…œí”Œë¦¿)
    - name: "Scan 2/5: Nuclei (WordPress Templates)"
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "2ï¸âƒ£ Nuclei - WordPress í…œí”Œë¦¿"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/2_nuclei.sh || true
    
    # 6. wfuzz (ë¹ ë¥¸ SQLi)
    - name: "Scan 3/5: wfuzz (Fast SQLi Screening)"
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "3ï¸âƒ£ wfuzz - ë¹ ë¥¸ SQLi ìŠ¤í¬ë¦¬ë‹"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/3_wfuzz.sh || true
    
    # 7. Dalfox (XSS)
    - name: "Scan 4/5: Dalfox (XSS Detection)"
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "4ï¸âƒ£ Dalfox - XSS íƒì§€"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/4_dalfox.sh || true
    
    # 8. SQLMap (SQLi í™•ì¸)
    - name: "Scan 5/5: SQLMap (SQLi Confirmation)"
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "5ï¸âƒ£ SQLMap - SQLi í™•ì¸"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/5_sqlmap.sh || true
    
    # 9. JSON í†µí•©
    - name: Generate unified JSON report
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š JSON í†µí•© (semgrep í˜•íƒœ)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/6_generate_json.sh
        
        echo ""
        echo "ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°:"
        jq -C '. | {total: (.results | length), zero_day: [.results[] | select(.extra.metadata.zero_day == true)] | length}' results/dast_results.json || true
    
    # 10. ì„œë²„ ì—…ë¡œë“œ
    - name: Upload results to dashboard
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¤ ì„œë²„ ì—…ë¡œë“œ"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        python3 scripts/7_upload.py results/dast_results.json
      continue-on-error: true
    
    # 11. ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (GitHub)
    - name: Upload scan results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: dast-scan-results-${{ github.run_number }}
        path: results/
        retention-days: 30
    
    # 12. ìš”ì•½ ì¶œë ¥
    - name: Print summary
      if: always()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… ìŠ¤ìº” ì™„ë£Œ!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        if [ -f results/dast_results.json ]; then
          echo "ğŸ“Š ìµœì¢… í†µê³„:"
          jq -r '
            "  ì´ ì·¨ì•½ì : \(.results | length)ê°œ",
            "  ì œë¡œë°ì´: \([.results[] | select(.extra.metadata.zero_day == true)] | length)ê°œ",
            "  Critical: \([.results[] | select(.extra.severity == "CRITICAL")] | length)ê°œ",
            "  High: \([.results[] | select(.extra.severity == "HIGH")] | length)ê°œ"
          ' results/dast_results.json || true
          
          echo ""
          echo "ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ:"
          echo "  Actions íƒ­ â†’ Artifacts â†’ 'dast-scan-results-${{ github.run_number }}'"
        else
          echo "âš ï¸  ê²°ê³¼ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        fi
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"