name: WordPress DAST Security Scan

on:
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰
  schedule:
    - cron: "0 15 * * *"  # ë§¤ì¼ 00:00 KST (UTC 15:00)

permissions:
  contents: read

jobs:
  dast-scan:
    # [ìˆ˜ì • 1] ubuntu-latest -> self-hosted (ë‚´ EC2 ëŸ¬ë„ˆ ì‚¬ìš©)
    runs-on: self-hosted
    
    env:
      TARGET_BASE: ${{ secrets.TARGET_URL }}
      WP_USERNAME: ${{ secrets.WP_USERNAME }}
      WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
      WPSCAN_API_TOKEN: ${{ secrets.WPSCAN_API_TOKEN }}
      DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout
      uses: actions/checkout@v4
    
    # [ìˆ˜ì • 2] ë””ë²„ê¹…: ì§„ì§œ ì—°ê²°ë˜ëŠ”ì§€ ëˆˆìœ¼ë¡œ í™•ì¸í•˜ê¸°
    - name: ğŸ” Check Connection & URL
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ•µï¸ ì—°ê²° í…ŒìŠ¤íŠ¸ ë° URL í™•ì¸"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        # SecretsëŠ” ***ë¡œ ê°€ë ¤ì§€ì§€ë§Œ, curl ì ‘ì† ë¡œê·¸(Connected to...)ë¥¼ í†µí•´ IP í™•ì¸ ê°€ëŠ¥
        curl -I -v --connect-timeout 5 ${{ secrets.TARGET_URL }} || echo "âŒ ì—°ê²° ì‹¤íŒ¨! ì£¼ì†Œë‚˜ ë°©í™”ë²½ì„ í™•ì¸í•˜ì„¸ìš”."

    # 2. ë„êµ¬ ì„¤ì¹˜ (ì»¨í…Œì´ë„ˆ ë°©ì‹ì´ ì•„ë‹ˆë¯€ë¡œ, ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ë©´ íŒ¨ìŠ¤ë¨)
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ ë„êµ¬ ì„¤ì¹˜/ì—…ë°ì´íŠ¸ ì¤‘..."
        
        sudo apt-get update -qq
        
        # WPScan
        sudo gem install wpscan || echo "WPScan already installed or error"
        
        # Nuclei
        go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
        sudo ln -sf ~/go/bin/nuclei /usr/local/bin/nuclei || true
        # [ìˆ˜ì • 3] Nuclei í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ (í•„ìˆ˜)
        nuclei -update-templates
        
        # Dalfox
        go install github.com/hahwul/dalfox/v2@latest
        sudo ln -sf ~/go/bin/dalfox /usr/local/bin/dalfox || true
        
        # SQLMap & Utils
        sudo apt-get install -y sqlmap jq bc python3-requests
        
        echo "âœ… ë„êµ¬ ì¤€ë¹„ ì™„ë£Œ!"

    # 3. ì¤€ë¹„
    - name: Prepare directories & permissions
      run: |
        mkdir -p results
        chmod +x scripts/*.sh
        chmod +x scripts/*.py
    
    # 4. WPScan (ê¸°ì¡´ CVE)
    - name: "Scan 1/5: WPScan (Known CVE)"
      run: |
        echo "1ï¸âƒ£ WPScan Start"
        ./scripts/1_wpscan.sh || true
      
    # 5. Nuclei (WordPress í…œí”Œë¦¿)
    - name: "Scan 2/5: Nuclei (WordPress Templates)"
      run: |
        echo "2ï¸âƒ£ Nuclei Start"
        ./scripts/2_nuclei.sh || true
    
    # 6. wfuzz (ë¹ ë¥¸ SQLi)
    - name: "Scan 3/5: wfuzz (Fast SQLi Screening)"
      run: |
        echo "3ï¸âƒ£ wfuzz Start"
        ./scripts/3_wfuzz.sh || true
    
    # 7. Dalfox (XSS)
    - name: "Scan 4/5: Dalfox (XSS Detection)"
      run: |
        echo "4ï¸âƒ£ Dalfox Start"
        ./scripts/4_dalfox.sh || true
    
    # 8. SQLMap (SQLi í™•ì¸)
    - name: "Scan 5/5: SQLMap (SQLi Confirmation)"
      run: |
        echo "5ï¸âƒ£ SQLMap Start"
        ./scripts/5_sqlmap.sh || true
    
    # 9. JSON í†µí•©
    - name: Generate unified JSON report
      run: |
        ./scripts/6_generate_json.sh
        echo "ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°:"
        jq -C '. | {total: (.results | length)}' results/dast_results.json || true
    
    # 10. ì„œë²„ ì—…ë¡œë“œ
    - name: Upload results to dashboard
      run: |
        python3 scripts/7_upload.py results/dast_results.json
      continue-on-error: true
    
    # 11. ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (GitHub)
    - name: Upload scan results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: dast-scan-results-${{ github.run_number }}
        path: results/
        retention-days: 30
    
    # 12. ìš”ì•½ ì¶œë ¥
    - name: Print summary
      if: always()
      run: |
        echo "âœ… ìŠ¤ìº” ì™„ë£Œ!"
