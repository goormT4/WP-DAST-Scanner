name: WordPress DAST Security Scan

on:
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰
  schedule:
    - cron: "0 15 * * *"  # ë§¤ì¼ 00:00 KST (UTC 15:00)

permissions:
  contents: read

jobs:
  dast-scan:
    # âœ… ìˆ˜ì • 1: self-hosted ì‚¬ìš© (VPC ë‚´ë¶€ ì‹¤í–‰)
    runs-on: self-hosted
    
    env:
      TARGET_BASE: ${{ secrets.TARGET_URL }}
      WP_USERNAME: ${{ secrets.WP_USERNAME }}
      WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
      WPSCAN_API_TOKEN: ${{ secrets.WPSCAN_API_TOKEN }}
      DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout code
      uses: actions/checkout@v4
    
    # âœ… ìˆ˜ì • 2: ì—°ê²° í…ŒìŠ¤íŠ¸ ì¶”ê°€ (ë””ë²„ê¹…)
    - name: ğŸ” Check Connection & URL
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ•µï¸ ì—°ê²° í…ŒìŠ¤íŠ¸ ë° URL í™•ì¸"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Target: ${TARGET_BASE}"
        curl -I -v --connect-timeout 5 "${TARGET_BASE}" || echo "âŒ ì—°ê²° ì‹¤íŒ¨! ì£¼ì†Œë‚˜ ë°©í™”ë²½ì„ í™•ì¸í•˜ì„¸ìš”."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # 2. ë„êµ¬ ì„¤ì¹˜/ì—…ë°ì´íŠ¸
    - name: Install dependencies
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ ë„êµ¬ ì„¤ì¹˜/ì—…ë°ì´íŠ¸ ì¤‘..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # APT ì—…ë°ì´íŠ¸ (ì¡°ìš©íˆ)
        sudo apt-get update -qq
        
        # WPScan (Ruby)
        echo "â–¶ WPScan..."
        sudo gem install wpscan || echo "âš ï¸ WPScan already installed or error"
        
        # Nuclei (Go)
        echo "â–¶ Nuclei..."
        go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
        sudo ln -sf ~/go/bin/nuclei /usr/local/bin/nuclei || true
        # âœ… ìˆ˜ì • 3: Nuclei í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ (í•„ìˆ˜!)
        nuclei -update-templates
        
        # Dalfox (Go)
        echo "â–¶ Dalfox..."
        go install github.com/hahwul/dalfox/v2@latest
        sudo ln -sf ~/go/bin/dalfox /usr/local/bin/dalfox || true
        
        # SQLMap & Utils
        echo "â–¶ SQLMap & Utils..."
        sudo apt-get install -y sqlmap jq bc python3-requests
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… ë„êµ¬ ì¤€ë¹„ ì™„ë£Œ!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # ë„êµ¬ ë²„ì „ í™•ì¸
        echo ""
        echo "ğŸ”§ ì„¤ì¹˜ëœ ë„êµ¬ ë²„ì „:"
        wpscan --version || echo "WPScan: N/A"
        nuclei -version || echo "Nuclei: N/A"
        dalfox version || echo "Dalfox: N/A"
        sqlmap --version | head -1 || echo "SQLMap: N/A"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # 3. ì¤€ë¹„
    - name: Prepare directories & permissions
      run: |
        mkdir -p results
        chmod +x scripts/*.sh
        chmod +x scripts/*.py
    
    # 4. WPScan (ê¸°ì¡´ CVE)
    - name: "1ï¸âƒ£ WPScan - ê¸°ì¡´ CVE íƒì§€"
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "1ï¸âƒ£ WPScan - ê¸°ì¡´ CVE íƒì§€"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/1_wpscan.sh || true
    
    # 5. Nuclei (WordPress í…œí”Œë¦¿)
    - name: "2ï¸âƒ£ Nuclei - WordPress í…œí”Œë¦¿"
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "2ï¸âƒ£ Nuclei - WordPress í…œí”Œë¦¿"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/2_nuclei.sh || true
    
    # 6. wfuzz (ë¹ ë¥¸ SQLi)
    - name: "3ï¸âƒ£ wfuzz - ë¹ ë¥¸ SQLi ìŠ¤í¬ë¦¬ë‹"
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "3ï¸âƒ£ wfuzz - ë¹ ë¥¸ SQLi ìŠ¤í¬ë¦¬ë‹"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/3_wfuzz.sh || true
    
    # 7. Dalfox (XSS)
    - name: "4ï¸âƒ£ Dalfox - XSS íƒì§€"
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "4ï¸âƒ£ Dalfox - XSS íƒì§€"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/4_dalfox.sh || true
    
    # 8. SQLMap (SQLi í™•ì¸)
    - name: "5ï¸âƒ£ SQLMap - ì‹¬ì¸µ SQLi ê²€ì¦"
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "5ï¸âƒ£ SQLMap - ì‹¬ì¸µ SQLi ê²€ì¦"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/5_sqlmap.sh || true
    
    # 9. JSON í†µí•©
    - name: "ğŸ“Š JSON í†µí•© (semgrep í˜•íƒœ)"
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š JSON í†µí•© (semgrep í˜•íƒœ)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ./scripts/6_generate_json.sh
        
        echo ""
        echo "ğŸ“„ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°:"
        jq -C '. | {
          "ì´ ì·¨ì•½ì ": .results.total,
          "ì œë¡œë°ì´": .results.zero_day
        }' results/dast_results.json || true
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # 10. ì„œë²„ ì—…ë¡œë“œ
    - name: "ğŸ“¤ ì„œë²„ ì—…ë¡œë“œ"
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¤ ì„œë²„ ì—…ë¡œë“œ"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        python3 scripts/7_upload.py results/dast_results.json
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      continue-on-error: true
    
    # 11. ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (GitHub)
    - name: Upload scan results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: dast-scan-results-${{ github.run_number }}
        path: results/
        retention-days: 30
      if: always()
    
    # 12. ìš”ì•½ ì¶œë ¥
    - name: Print summary
      if: always()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… ìŠ¤ìº” ì™„ë£Œ!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ -f results/dast_results.json ]; then
          echo "ğŸ“Š ìµœì¢… í†µê³„:"
          jq '{
            "ì´ ì·¨ì•½ì ": .results.total,
            "ì œë¡œë°ì´": .results.zero_day,
            "Critical": (.results.vulnerabilities | map(select(.severity=="CRITICAL")) | length),
            "High": (.results.vulnerabilities | map(select(.severity=="HIGH")) | length),
            "Medium": (.results.vulnerabilities | map(select(.severity=="MEDIUM")) | length),
            "Info": (.results.vulnerabilities | map(select(.severity=="INFO")) | length)
          }' results/dast_results.json || true
          
          echo ""
          echo "ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ:"
          echo "  Actions íƒ­ â†’ Artifacts â†’ 'dast-scan-results-${{ github.run_number }}'"
        else
          echo "âš ï¸ ê²°ê³¼ íŒŒì¼ ì—†ìŒ"
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
